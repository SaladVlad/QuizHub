apiVersion: batch/v1
kind: Job
metadata:
  name: elasticsearch-ilm-setup
  namespace: observability
spec:
  template:
    spec:
      restartPolicy: OnFailure
      containers:
      - name: curl
        image: curlimages/curl:latest
        command: ["/bin/sh"]
        args:
          - -c
          - |
            # Wait for Elasticsearch to be ready
            until curl -s http://elasticsearch.observability.svc.cluster.local:9200/_cluster/health | grep -q '"status":"green\|yellow"'; do
              echo "Waiting for Elasticsearch..."
              sleep 5
            done

            echo "Elasticsearch is ready. Creating ILM policy..."

            # Create ILM policy for QuizHub logs
            curl -X PUT "http://elasticsearch.observability.svc.cluster.local:9200/_ilm/policy/quizhub-policy" \
              -H 'Content-Type: application/json' \
              -d '{
              "policy": {
                "phases": {
                  "hot": {
                    "min_age": "0ms",
                    "actions": {
                      "rollover": {
                        "max_size": "5GB",
                        "max_age": "1d",
                        "max_docs": 10000000
                      },
                      "set_priority": {
                        "priority": 100
                      }
                    }
                  },
                  "warm": {
                    "min_age": "2d",
                    "actions": {
                      "set_priority": {
                        "priority": 50
                      },
                      "forcemerge": {
                        "max_num_segments": 1
                      },
                      "shrink": {
                        "number_of_shards": 1
                      }
                    }
                  },
                  "delete": {
                    "min_age": "30d",
                    "actions": {
                      "delete": {}
                    }
                  }
                }
              }
            }'

            echo ""
            echo "ILM policy created successfully!"

            # Create index templates for each service
            for service in gateway userservice quizservice resultservice; do
              echo "Creating index template for $service..."

              curl -X PUT "http://elasticsearch.observability.svc.cluster.local:9200/_index_template/quizhub-${service}-template" \
                -H 'Content-Type: application/json' \
                -d "{
                \"index_patterns\": [\"quizhub-${service}-*\"],
                \"template\": {
                  \"settings\": {
                    \"number_of_shards\": 1,
                    \"number_of_replicas\": 0,
                    \"index.lifecycle.name\": \"quizhub-policy\",
                    \"index.lifecycle.rollover_alias\": \"quizhub-${service}\"
                  },
                  \"mappings\": {
                    \"properties\": {
                      \"@timestamp\": {\"type\": \"date\"},
                      \"service.name\": {\"type\": \"keyword\"},
                      \"service.environment\": {\"type\": \"keyword\"},
                      \"application\": {\"type\": \"keyword\"},
                      \"json.Level\": {\"type\": \"keyword\"},
                      \"json.Properties.ServiceName\": {\"type\": \"keyword\"},
                      \"json.Properties.Environment\": {\"type\": \"keyword\"},
                      \"json.MessageTemplate\": {\"type\": \"text\"},
                      \"json.RenderedMessage\": {\"type\": \"text\"},
                      \"kubernetes.namespace\": {\"type\": \"keyword\"},
                      \"kubernetes.pod.name\": {\"type\": \"keyword\"},
                      \"kubernetes.container.name\": {\"type\": \"keyword\"}
                    }
                  }
                },
                \"priority\": 500
              }"
              echo ""
            done

            # Create bootstrap indices with aliases
            for service in gateway userservice quizservice resultservice; do
              echo "Creating bootstrap index for $service..."

              curl -X PUT "http://elasticsearch.observability.svc.cluster.local:9200/%3Cquizhub-${service}-%7Bnow%2Fd%7D-000001%3E" \
                -H 'Content-Type: application/json' \
                -d "{
                \"aliases\": {
                  \"quizhub-${service}\": {
                    \"is_write_index\": true
                  }
                }
              }"
              echo ""
            done

            echo "âœ… All ILM policies, templates, and bootstrap indices created!"
